// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------
// 1. 유저 및 인증 (User & Auth)
// -----------------------------------------------------------

// 회원 유형 정의
enum UserRole {
  BUYER  // 구매자
  SELLER // 판매자
}

model User {
  id              String       @id @default(cuid())
  email           String    @unique // 로그인 ID (이메일)
  password        String    // 해시된 비밀번호
  nickname        String    @unique
  role            UserRole  @default(BUYER)
  profileImageUrl String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 관계 설정
  store           Store?    // 판매자: 1명의 판매자는 0 또는 1개의 스토어를 가집니다.
  inquiries       Inquiry[] // 문의
  reviews         Review[]  // 리뷰
  cartItems       CartItem[] // 장바구니 항목
  orders          Order[]   // 주문/구매
  userPoints      UserPoint? // 포인트 및 등급 정보
  favoriteStores  FavoriteStore[] // 관심 스토어
}

// -----------------------------------------------------------
// 2. 스토어 및 상품 (Store & Product)
// -----------------------------------------------------------

model Store {
  id             String       @id @default(cuid())
  sellerId       String       @unique // 판매자 ID (1:1 관계)
  name           String
  address        String
  phoneNumber    String
  storeImageUrl  String?
  description    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // 관계 설정
  seller         User      @relation(fields: [sellerId], references: [id])
  products       Product[] // 상품
  favorites      FavoriteStore[] // 이 스토어를 관심 스토어로 등록한 사용자 목록
}

// 상품 카테고리 정의
enum ProductCategory {
  TOP
  BOTTOM
  OUTER
  DRESS
  SKIRT
  SHOES
  ACC
  ETC // 기타
}

model Product {
  id             String               @id @default(cuid())
  storeId        String
  name           String
  mainImageUrl   String
  price          Int               // 판매가
  category       ProductCategory
  detailInfo     String
  totalSales     Int               @default(0) // 판매량 (추천 상품 및 정렬 기준)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // 할인 관련 필드 (선택 사항)
  discountPrice  Int?              // 할인가
  discountStart  DateTime?         // 할인 시작일
  discountEnd    DateTime?         // 할인 종료일

  // 관계 설정
  store          Store             @relation(fields: [storeId], references: [id])
  stocks         ProductStock[]    // 사이즈별 재고
  inquiries      Inquiry[]         // 문의
  reviews        Review[]          // 리뷰
  cartItems      CartItem[]        // 장바구니 항목
  orderItems     OrderItem[]       // 주문된 상품 항목
}

model ProductStock {
  id        String     @id @default(cuid())
  productId String
  size      String  // 예: S, M, L, 260 등
  quantity  Int     @default(0)

  @@unique([productId, size]) // 상품별 사이즈는 유일해야 함

  // 관계 설정
  product   Product @relation(fields: [productId], references: [id])
}

// -----------------------------------------------------------
// 3. 장바구니 및 구매 (Cart & Purchase)
// -----------------------------------------------------------

model CartItem {
  id        String      @id @default(cuid())
  userId    String
  productId String
  quantity  Int
  size      String   // 선택된 사이즈
  createdAt DateTime @default(now())

  @@unique([userId, productId, size]) // 사용자, 상품, 사이즈 조합은 유일해야 함

  // 관계 설정
  user      User     @relation(fields: [userId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
}

// 주문 상태 정의
enum OrderStatus {
  PENDING    // 결제 대기
  PAID       // 결제 완료
  SHIPPED    // 배송 중
  DELIVERED  // 배송 완료
  CANCELED   // 취소
}

model Order {
  id                 String         @id @default(cuid())
  userId             String
  orderNumber        String      @unique
  totalAmount        Int         // 총 결제 금액
  usedPoints         Int         @default(0) // 사용된 포인트
  status             OrderStatus @default(PAID)
  recipientName      String
  recipientPhone     String
  deliveryAddress    String
  paymentDate        DateTime?   // 결제 완료 시점
  createdAt          DateTime    @default(now())

  // 관계 설정
  user               User        @relation(fields: [userId], references: [id])
  orderItems         OrderItem[] // 주문된 상품 항목 목록
}

model OrderItem {
  id        String     @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Int     // 주문 당시 상품 가격 (할인 적용 가격)
  size      String  // 주문된 사이즈

  // 관계 설정
  order     Order   @relation(fields: [orderId], references: [id])
  product   Product @relation(fields: [productId], references: [id])
  review    Review? // 이 주문 항목에 대해 작성된 리뷰 (1:1 또는 1:0)
}

// -----------------------------------------------------------
// 4. 문의 및 리뷰 (Inquiry & Review)
// -----------------------------------------------------------

model Inquiry {
  id        String      @id @default(cuid())
  userId    String
  productId String
  title     String
  content   String
  isSecret  Boolean  @default(false) // 비밀글 여부
  hasAnswer Boolean  @default(false) // 답변 상태
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계 설정
  user      User     @relation(fields: [userId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  answer    InquiryAnswer? // 답변 (1:1 관계)
}

model InquiryAnswer {
  id          String      @id @default(cuid())
  inquiryId   String      @unique
  sellerId    String      // 답변한 판매자 ID (필요시)
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 관계 설정
  inquiry     Inquiry  @relation(fields: [inquiryId], references: [id])
}

model Review {
  id          String      @id @default(cuid())
  userId      String
  productId   String
  orderItemId String      @unique // 구매한 상품에 대해서만 작성 가능하도록 OrderItem과 1:1 연결
  rating      Int      // 별점 (1~5)
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 관계 설정
  user        User     @relation(fields: [userId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
}

// -----------------------------------------------------------
// 5. 포인트 및 등급 (Points & Grade)
// -----------------------------------------------------------

// 사용자 등급 정의
enum UserGrade {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

model UserPoint {
  id              String       @id @default(cuid())
  userId          String       @unique
  currentPoints   Int       @default(0) // 현재 보유 포인트
  accumulatedAmount Int     @default(0) // 누적 구매 금액 (등급 산정 기준)
  grade           UserGrade @default(BRONZE)
  pointRate       Float     @default(0.01) // 등급별 적립률 (예: 1% = 0.01)

  // 관계 설정
  user            User      @relation(fields: [userId], references: [id])
}

// -----------------------------------------------------------
// 6. 관심 스토어 (Favorite Store)
// -----------------------------------------------------------

model FavoriteStore {
  id        String      @id @default(cuid())
  userId    String
  storeId   String
  createdAt DateTime @default(now())

  @@unique([userId, storeId]) // 사용자별 스토어는 한 번만 등록 가능

  // 관계 설정
  user      User     @relation(fields: [userId], references: [id])
  store     Store    @relation(fields: [storeId], references: [id])
}